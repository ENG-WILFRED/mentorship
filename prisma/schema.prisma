// Prisma schema for a full-featured church app
// Includes users, roles, sermons, events, feedback, attendance, donations, groups, and more

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  firstName String
  lastName  String
  email     String   @unique
  password  String
  role      Role     @default(GUEST)
  createdAt DateTime @default(now())
  mentor    Mentor?
  feedbacks Feedback[]
  sermons   Sermon[]
  mediaUploaded  Media[]
  sermonComments SermonComment[]
  sermonReactions SermonReaction[]
  memorableId String @unique
  
  // NEW: Prayer request relationships
  createdPrayerRequests PrayerRequest[] @relation("CreatedPrayerRequests")
  prayedForRequests     PrayerRequestPrayedBy[] @relation("PrayedForRequests")
}


model Mentor {
  id        Int      @id @default(autoincrement())
  name      String
  bio       String?
  location  String?
  age       Int?
  education String?
  maritalStatus String?
  phone     String?
  email     String?
  experience Int?
  skills    String?
  user      User?    @relation(fields: [userId], references: [id])
  userId    Int? @unique
  missions  MissionMentor[]
  
  // NEW: Prayer requests assigned to this mentor
  prayerRequests PrayerRequest[]
}


model School {
  id        Int      @id @default(autoincrement())
  name      String
  location  String
  gender    String
  population Int
  contact   String?
  logo      String?
  missions  MissionSchool[]

  Report Report[]
}

model Mission {
  id        Int      @id @default(autoincrement())
  title     String
  date      DateTime
  status    MissionStatus @default(UPCOMING)
  description String?
  goals     String?
  outcomes  String?
  notes     String?
  students  Int
  topic     String
  mentors   MissionMentor[]
  schools   MissionSchool[]
  reports   Report[]
  media     Media[] // 1-to-many relation
}
model PrayerRequest {
  id         Int             @id @default(autoincrement())
  request    String
  school     String?
  priority   PrayerPriority  @default(MEDIUM)
  notes      String?
  studentId  String?
  grade      String?
  subject    String?
  status     PrayerStatus    @default(PENDING)
  date       DateTime        @default(now())
  category   String?
  email      String?
  name       String?
  
  // Relationship: User who created the prayer request
  createdBy   User?          @relation("CreatedPrayerRequests", fields: [createdById], references: [id])
  createdById Int?
  
  // Relationship: Mentor assigned to this prayer request
  assignedMentor   Mentor?    @relation(fields: [assignedMentorId], references: [id])
  assignedMentorId Int?
  
  // Relationship: Many-to-many for users who prayed for this request
  prayedByUsers    PrayerRequestPrayedBy[]
  
  @@index([createdById])
  @@index([assignedMentorId])
  @@index([status])
}


model PrayerRequestPrayedBy {
  prayerRequest   PrayerRequest @relation(fields: [prayerRequestId], references: [id], onDelete: Cascade)
  prayerRequestId Int
  user            User          @relation("PrayedForRequests", fields: [userId], references: [id], onDelete: Cascade)
  userId          Int
  prayedAt        DateTime      @default(now())
  
  @@id([prayerRequestId, userId])
  @@index([userId])
}

model MissionMentor {
  mission   Mission @relation(fields: [missionId], references: [id])
  missionId Int
  mentor    Mentor  @relation(fields: [mentorId], references: [id])
  mentorId  Int
  @@id([missionId, mentorId])
}

model MissionSchool {
  mission   Mission @relation(fields: [missionId], references: [id])
  missionId Int
  school    School  @relation(fields: [schoolId], references: [id])
  schoolId  Int
  @@id([missionId, schoolId])
}

model Report {
  id        Int      @id @default(autoincrement())
  mission   Mission  @relation(fields: [missionId], references: [id])
  missionId Int
  school    School   @relation(fields: [schoolId], references: [id])
  schoolId  Int
  date      DateTime
  topic     String
  students  Int
  outcome   String
}



model Feedback {
  id        Int      @id @default(autoincrement())
  message   String
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])
  userId    Int?
}

model Sermon {
  id          Int               @id @default(autoincrement())
  title       String
  description String?
  videoUrl    String?
  youtubeId   String?            @unique
  audioUrl    String?
  coverImage  String?
  topic       String?
  author      String?
  createdAt   DateTime          @default(now())
  createdBy   User?             @relation(fields: [createdById], references: [id])
  createdById Int?
  comments    SermonComment[]
  reactions   SermonReaction[]
}

model SermonComment {
  id        Int      @id @default(autoincrement())
  sermon    Sermon   @relation(fields: [sermonId], references: [id])
  sermonId  Int
  user      User?    @relation(fields: [userId], references: [id])
  userId    Int?
  message   String
  createdAt DateTime @default(now())
}

model SermonReaction {
  id        Int      @id @default(autoincrement())
  sermon    Sermon   @relation(fields: [sermonId], references: [id])
  sermonId  Int
  user      User?    @relation(fields: [userId], references: [id])
  userId    Int?
  emoji     String
  createdAt DateTime @default(now())

  @@unique([sermonId, userId, emoji])
}

// Add to your existing schema.prisma
model Media {
  id          Int      @id @default(autoincrement())
  url         String
  caption     String
  type        String  //"image" | "video"
  category    MediaCategory
  date        DateTime
  
  //link to mission
  missionId   Int?
  mission    Mission? @relation(fields: [missionId], references: [id])
  // Relations - Changed to Int to match User.id
  uploaderId  Int
  uploader    User     @relation(fields: [uploaderId], references: [id])
  
  // Stats
  likes       Int      @default(0)
  views       Int      @default(0)
  
  // Metadata
  description String?
  location    String?
  tags        Tag[]
  // Optional cloud storage IDs and video references
  cloudinaryPublicId String?
  youtubeId String?
  videoUrl String?
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([category])
  @@index([type])
  @@index([date])
  @@index([uploaderId])
}

model Tag {
  id    Int    @id @default(autoincrement())  // Changed to match your schema style
  name  String @unique
  media Media[]
}

enum MediaType {
  IMAGE
  VIDEO
  DOCUMENT
}

enum MediaCategory {
  MISSION
  SERMON
  EVENT
  STUDENT
}

enum MissionStatus {
  UPCOMING
  ONGOING
  COMPLETED
}

enum Role {
  STUDENT
  MENTOR
  ADMIN
  GUEST
}

enum PrayerPriority {
  HIGH
  MEDIUM
  LOW
}

enum PrayerStatus {
  PENDING
  IN_PROGRESS
  FULFILLED
}
